Splunk 설치 OS prerequisites
========================



##  OS prerequisites
</br>여기서는 Linux 기반의 설치만 설명.

----------

- NTP 설정
</br> 스플렁크를 분산환경에서 설치시 (eg: index cluster등) 모든 노드는 시간 동기화가 되어 있어야 한다.
</br>ntp service 설치
> yum install ntp

</br> 시간 기준이 될 서버(아래 예에서는 192.168.100.15 서버) 한대의 /etc/ntp.conf 를 아래와 같이 설정
```
# Use the local clock
server 127.127.1.0 prefer
fudge  127.127.1.0 stratum 10
driftfile /var/lib/ntp/drift
broadcastdelay 0.008

# Give localhost full access rights
restrict 127.0.0.1

# Give machines on our network access to query us

restrict 192.168.100.0 mask 255.255.255.0 nomodify notrap
```
</br>나머지 서버들의 /etc/ntp.conf 는 기존 파일을 백업해놓고, 아래와 같이 한줄만 설정한다.
```
 server 192.168.100.15      # 위의 기준 서버의 ip로 지정
```
</br>설정이 끝났으면 모든 서버에서 다음과 같은 순서로 시간 동기화를 실행
```
$ service ntpd stop
$ ntpdate -u 192.168.100.15
$ ntpdate -u 192.168.100.15
$ ntpdate -u 192.168.100.15
$ service ntpd start
$ chkconfig ntpd on
```
</br>기준 서버 및 나머지 서버에서 확인
> ntpq -pn



- ulimit 설정

Splunk와 관계된 가장 중요한 커널 파라미터는 하기 3가지 정도이다.
</br>

file size
> ulimit -f

Splunk의 bucket을 압축해제 했을때 매우 클 수 있기 때문에 unlimited 또는 충분히 커야 한다.  

open files

> ulimit -n

최소 8192 이상 설정되어 있어야 하고, Splunk전용의 서버라면 충분히 크게 설정(보통 100,000 정도 설정)</br>
/etc/sysctl.conf에 설정되는 fs.file-max 값은 커널 전체에 적용되는 값. 사용자 개별 설정인 ulimit -n 값은 당연히 fs.file-max값보다는 작게 설정되어야 함.  

max user process-runner

> ulimit -u

최소 64k 이상 설정

data segment size

> ulimit -d

최소 1073741824 bytes (1GB) 이상 설정.
시스템을 확인해보고 위의 값보다 작다면 /etc/security/limits.conf 파일을 수정합니다.</br>
"splunk"라는 OS사용자로 운영중인 경우 open files값과 max user processes수을 각각 100,000으로 설정하려면, limits.conf 파일의 가장 아래 부분에 다음과 같은 라인을 추가 합니다.
```
splunk      hard     nofile     100000
splunk      soft      nofile     100000
splunk      hard     nproc     100000
splunk      soft      nproc     100000
```

사용자의 ulimit 값을 변경했으면, telnet 또는 ssh세션을 로그아웃하고 재로그인 후  ulimit -a 명령으로 적용되었는지 확인한다.  








-  THP 설정

RedHat, CentOS, Ubuntu 에는 대용량 메모리 관리를 위해서 Transparant Huge Page 설정이 기본으로 Enable 되어 있다. 이 설정이 enable되어 있으면THP기능의 swappable hugepage 기능 때문에 오라클DB의 경우 I/O throughput 성능이 30% 정도 감소한다는 보고가 있다.

http://docs.splunk.com/Documentation/Splunk/latest/ReleaseNotes/SplunkandTHP
</br>
내 시스템의 THP설정 확인하기
> $ cat /sys/kernel/mm/transparent_hugepage/enabled
> [always] never

대괄호 안에 나오는 값이 지금 설정된 값인데, 위와 같이 [always]라고 나오면, 항상 enable되어있다는 의미이고, 아래에 나오는 방법으로 disable 시켜야 한다.

THP 설정을 disable 시키는 방법
</br> /etc/grub.conf 파일의 kernel 라인에 transparent_hugepage=never 설정 추가
</br> grub.conf 파일 수정 예제
```
# grub.conf generated by anaconda
#
# Note that you do not have to rerun grub after making changes to this file
# NOTICE:  You have a /boot partition.  This means that
#          all kernel and initrd paths are relative to /boot/, eg.
#          root (hd0,0)
#          kernel /vmlinuz-version ro root=/dev/mapper/vg_sandbox-lv_root
#          initrd /initrd-[generic-]version.img
#boot=/dev/sda
default=0
timeout=5
splashimage=(hd0,0)/grub/splash.xpm.gz
hiddenmenu
title CentOS (2.6.32-358.6.2.el6.x86_64)
    root (hd0,0)
    kernel /vmlinuz-2.6.32-358.6.2.el6.x86_64 ro root=/dev/mapper/vg_sandbox-lv_root rd_NO_LUKS rd_LVM_LV=vg_sandbox/lv_root LANG=en_US.UTF-8 rd_NO_MD SYSFONT=latarcyrheb-sun16 crashkernel=auto rd_NO_DM  KEYBOARDTYPE=pc KEYTABLE=us transparent_hugepage=never rd_LVM_LV=vg_sandbox/lv_swap quiet consoleblank=0
    initrd /initramfs-2.6.32-358.6.2.el6.x86_64.img
```
위 내용은 서버를 재부팅 해야 적용된다.
재부팅 없이 즉시 THP를 disable하려면 하기와 같이 수행한다. </br>
다음 재부팅후에 원복되기 때문에 grub.conf를 바꾸는것이 좋다.

> echo never > /sys/kernel/mm/transparent_hugepage/enabled

스플렁크 설치 후 THP 설정이 disable되었는지 확인하는 방법
>#grep transparent /opt/splunk/var/log/splunk/splunkd.log | tail
>… INFO  ulimit - Linux transparent hugetables support, enabled="never”



- iptables 설정

보안상 특정 ip에서만 splunkweb에 접속가능하도록 하고 싶은 경우 접속 허용 ip 들을 모두 ACCEPT한
후 나머지를 차단.

```
$ sudo iptables -A INPUT -s 123.123.123.0/15 -p tcp --dport 8000 -j ACCEPT
$ sudo iptables -A INPUT -s 124.124.124.10 -p tcp --dport 8000 -j ACCEPT
$ sudo iptables -A INPUT -p tcp --dport 8000 -j DROP
```
- SELinux 설정
현재 방화벽 셋팅 확인한다.
```
sestatus
```
> /etc/selinux/config, set “SELINUX=disabled”



</hr>


**UDP Input 에 관련된 시스템 튜닝**

------------

UDP를 통해 다량의 보안 장비 syslog데이터를 수집하는 경우,UDP 특성상 패킷 drop이 많이 발생할 수 있다. </br>UDP라서 완전히 손실을 없애기는 힘들지만 다음과 같은 방법으로 손실을 거의 없앨 수 있다.</br>

UDP 패킷 손실이 생기는 주된 이유.
1.	OS Kernel 레벨에서 충분치 않은 버퍼 크기
일반 Linux배포본를 설치하면 Kernel parameter에 대한 기본 값이 충분치 크지 않기 때문에, 반드시 수정해서 늘려줘야 한다.
2.	UDP를 수신하는 어플리케이션(Heavy Forwarder등)이 충분히 빠르게 처리하지 못하는 경우
OS버퍼에서 해당 메세지가 넘쳐서 밀려나가기 전에 어플리케이션에서 받아가야 하는데, 빠르게 동작하지 못하는 경우에는 놓칠 수 있다.
</br> 기본적으로 어플리케이션 프로세스의 성능 튜닝이 필요하겠지만, Splunk에서는 buffer 크기 조정 및 persistentQueue를 enable시켜서 문제를 완화할 수 있다.


**OS 레벨에서 drop되는 UDP 패킷의 양 모니터링 방법**

netstat -su 을 실행하면 아래와 같은 결과가 나옵니다.?
```
netstat -su?
IcmpMsg:
 InType3: 9372
 InType8: 1
 OutType0: 1
 OutType3: 9372
Udp:
 57 packets received
 9372 packets to unknown port received.
 0 packet receive errors  <-- drop된 패킷 수
 9427 packets sent
...
```

다른 방법:  splunk에서 scripted input으로 위의 내용을 주기적으로 수집해서 증가량을 모니터링
scripted input으로 "netstat -su" 를 1분 주기로 실행해서 indexing
적절한 props.conf 설정 필요 (아래와 유사하게 설정하시면 될 듯합니다. 일반적인 내용이므로 생략…)

```
SHOULD_LINEMERGE = true
BREAK_ONLY_BEFORE = IcmpMsg
DATETIME_CONFIG = CURRENT
```
수집후에는 "packet receive" 앞에 있는 숫자를 적절히 필드 추출.

**OS Parameter 수정**
root 계정으로 아래를 수행
```
sysctl -w net.core.rmem_max=33554432
sysctl -w net.ipv4.udp_mem='262144 327680 393216'
sysctl -w net.core.netdev_max_backlog=2000
```
재부팅시에도 반영될 수 있도록 위의 내용을 /etc/sysctl.conf 파일에 반영


**Splunk에서 buffer크기 및 persistent queue 설정**
UDP input을 정의한 해당 inputs.conf 파일에 아래와같이 설정
```
 [udp://10541]
…
_rcvbuf = 16777216  시스템이 소캣별로 잡는 버퍼
queueSize = 16MB   스플렁크 내의 UDP버퍼
persistentQueueSize = 128MB   디스크 버퍼
...
```

_rcvbuf가 OS 의 rmem_max보다 같거나 작아야 함. </br>
Drop을 0로 가져갈 경우는 persistentQueue를 0 로.. queueSize 를 크게. </br>
초당 10Mb 정도면 현실적임. 초당 10MB ? 100Mbps 임. 하루 1T 포트당 144Mbyte  - 1G .. syslogNG </br>

UF  index 로 output.conf에 forceTimeBasedAutoLB = true 를 추가해 줄것. </br>?

참고노트:
http://wiki.splunk.com/Community:UDPInputs
https://answers.splunk.com/answers/7001/udp-drops-on-linux.html
http://docs.splunk.com/Documentation/Splunk/6.2.2/Data/SyslogTCP


**기타: non root 유저로 스플렁크 설치시 고려사항**


------------

http://docs.splunk.com/Documentation/Splunk/latest/Installation/RunSplunkasadifferentornon-rootuser
